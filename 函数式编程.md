> [!IMPORTANT]
> 函数式编程是在 Android 原生开发与 Flutter 开发中都相当常用的一种编程范式，在很多教程中，这种范式主要以匿名函数（即 Lambda 表达式）的形式出现
> 
> 你需要的前置知识有：
> - 较为熟练掌握 C 语言（其他语言也行）中的**函数**
> - 了解何为面向对象编程，很多情况下它们是相互结合的

> **函数是第一等公民**

# 函数式编程

## 介绍一下

事实证明，如果你不事先了解什么是函数式编程，那你在面对**匿名函数（即 lambda 表达式）** 时极大概率会一头雾水，尤其是在 **Android 原生开发与 Flutter 开发**中，你经常要给对象传入某个函数（许多时候会是匿名函数）。如果你尝试直接去了解何为匿名函数，那将要付出极大的理解成本（可能还没理解）

由于 Kotlin 的语法糖太多了很难读懂，以下所有的代码示例都会使用 Kotlin 和 Dart 两种语言

简单来说，函数式编程就是让函数可以和变量一样作为参数传到别的地方去，亦可作为返回值被返回。

## 然后就是代码时间

### 函数的类型

在函数式编程中，由于函数也能被当作变量，所以它们有具体的类型也是很合理的吧

那我们要怎么将它们分类呢？函数暴露在外部的只有参数列表和返回值，所以参数列表和返回值都一样的函数类型也是一样的

对于下面几个函数

```kotlin
fun add(a: Int, b: Int): Int {
    return a + b
}
fun hello(): Unit {  
    println("hello")  
}
val f = { x: Int, y: Double -> x / y }
```

```dart
int add(int a, int b) {
    return a + b;
}
void hello() {
    print('hello');
}
var f = (int x, double y) => x / y;
```

在 Kotlin 中，它们的类型分别是`(Int, Int) -> Int`，`() -> Unit`，`(Int, Double) -> Double`

而在 Dart 中则是`int Function(int, int)`， `void Function()`，`double Function(int, double)`

显然，两种语言都选择把参数列表和返回值拼在一起，记住它们现在的样子，接下来会有更多奇妙的函数类型出现

### 作为参数

试想一下，假如你有一个类`MyNumber`，长下面这样

```kotlin
class MyNumber(var data: Int) {  
  
    fun plus(value: Int) {  
        data += value  
    }  
  
    fun minus(value: Int) {  
        data -= value  
    }  
}
```

```dart
class MyNumber {
    int data;
    MyNumber({required this.data});
    
    void plus(int value) {
        data += value;
    }
    
    void minus(int value) {
        data -= value;
    }
}
```

然后你就想偷懒了，因为很多的运算即使定义了一辈子也不太可能用到几次（比如求`data`与 114514 的绝对值），那么，为什么我们不能在使用的时候再设计函数呢？

聪明的你想到可以专门准备一个函数来专门执行这些奇怪的需求

```kotlin
class MyNumber(var data: Int) {  
  
    fun plus(value: Int) {  
        data += value  
    }  
  
    fun minus(value: Int) {  
        data -= value  
    }  
  
    fun doSomething(something: () -> Unit) {  // Unit 对应 Java 中的 void
        something()  
    }  
}
```

```dart
class MyNumber {  
  int data;  
  
  MyNumber({required this.data});  
  
  void plus(int value) {  
    data += value;  
  }  
  
  void minus(int value) {  
    data -= value;  
  }  
  
  void doSomething(void Function() something) {  
    something();  
  }  
}
```

新添加的`doSomething`函数接收一个参数列表为空，返回值也为空的函数，也就是说，所有满足这个条件的函数都能被传入且执行

于是我们就可以做出以下神奇操作

```kotlin
val n = MyNumber(5)
fun hello() {  
    println("hello")  
}  
val nihao = { ->  // 这是一个匿名函数，但是我给它命名了，实际不要这么写，会很怪
    println("你好")  
}  
n.doSomething(::hello)  // ::表示引用函数，将函数作为参数直接传入，而不是执行后传入返回值
n.doSomething { hello() }  // 当然你也可以直接传入一个匿名函数来执行它
n.doSomething { nihao() }
```

```dart
var n = MyNumber(5);
void hello() {  
  print('hello');  
}  
  
var nihao = () => {  // 当然也不要这么写……
  print('你好')  
};  
  
n.doSomething(hello);  
n.doSomething(() => hello());  // 只是在模仿上边的写法……
n.doSomething(() => nihao());
```

如果要传入的函数像下面这样有参数，那也很好解决

```kotlin
fun doSomethingWithData(something: (Int) -> Unit) {  
    something(data)  
}
```

```dart
void doSomethingWithData(void Function(int value) something) {  
  something(data);  
}
```

在使用匿名函数的写法时要注意一下（Dart 就不用管了）

```kotlin
fun printNumber(number: Int) {  
    println(number)  
}

n.doSomethingWithData {v -> printNumber(v) }  
n.doSomethingWithData(::printNumber)
```

```dart
void printNumber(int number) {  
  print(number);  
}

n.doSomethingWithData(printNumber);  
n.doSomethingWithData((v) => printNumber(v));
```

有关 Kotlin 中的获取函数类型实例，可以在[这里](https://book.kotlincn.net/text/lambdas.html)获取更多信息

如果一个函数会接收或者返回函数，那这个函数可以被称为**高阶函数**

### 匿名函数（Lambda 表达式）

恭喜你！已经学会了给函数传入函数了！这通常是开发中使用函数式编程最多的情况了

但是看看上面的代码，你应该不会想在每次调用这些函数时都去声明一个函数的（尤其是那些只用一次的函数）

这时就要使用一个非常好的语言特性，也就是**匿名函数**了，匿名函数顾名思义就是没有名字的函数，它们的存在可以让我们在传入函数时不用事先声明（也省去了命名的麻烦）

匿名函数的结构基本长下面这样：

```kotlin
{ 参数列表 ->
    /* 函数体 */
}
// 如果没有参数
{
    /* 函数体 */
}
// 如果要指定返回值
fun(参数列表): 返回值类型 {
    /* 函数体 */
}
```

```dart
(参数列表) => {
    /* 函数体 */
} 
// 或者
(参数列表) => 表达式;
```

顺带一提，Java 的匿名函数语法长这样：

```java
(参数列表) -> {
    /* 函数体 */
}
// 或者
(参数列表) -> 表达式;
```

把上一节的函数参数换成匿名函数之后就会变成下面这样

```kotlin
n.doSomething { println("hello") }
n.doSomethingWithData { v -> // 这个参数的名字叫什么都行
    println(v)
}
```

```dart
n.doSomething(() => {
    print('hello')
});

// 简化一下
n.doSomething(() => print('hello'));

n.doSomething((v) => print(v));
```

在 Kotlin 中，匿名函数的返回值默认是其最后一行的值，普通的`return`是不能在匿名函数中使用的，如果有这方面的需要，可以来[这里](https://book.kotlincn.net/text/returns.html#%E8%BF%94%E5%9B%9E%E5%88%B0%E6%A0%87%E7%AD%BE)看看，虽然这时用普通的函数可能会更好

### 作为返回值

这种情况我还没把前置写好哈哈哈 (￣﹃￣)